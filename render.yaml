# render.yaml - Comentado Linha a Linha (Atualizado com ClassificaImagem Agent)

services:
# Se√ß√£o principal: define todos os servi√ßos da aplica√ß√£o
# YAML: estrutura hier√°rquica usando indenta√ß√£o

  - type: web
    # Tipo de servi√ßo: web application
    # Render oferece diferentes tipos: web, worker, cron, static
    # web: servi√ßo HTTP que aceita requisi√ß√µes externas
    
    name: agentes-ia-fia
    # Nome √∫nico do servi√ßo no Render
    # Usado para identifica√ß√£o e gera√ß√£o de URLs
    # Conven√ß√£o: kebab-case (h√≠fens em min√∫sculas)
    
    env: python
    # Ambiente de execu√ß√£o: Python runtime
    # Render detecta vers√£o automaticamente ou usa especificada
    # Outras op√ß√µes: node, ruby, go, etc.
    
    plan: free  # Pode ser alterado para starter, standard, pro conforme necess√°rio
    # Plano de pricing do Render
    # free: gratuito com limita√ß√µes (sleep ap√≥s inatividade)
    # starter/standard/pro: planos pagos com mais recursos
    # NOTA: ClassificaImagem Agent pode beneficiar de planos pagos para melhor performance
    
    buildCommand: |
      # Comando executado durante build/deploy
      # | indica string multi-linha literal em YAML
      
      pip install --upgrade pip
      # Atualiza pip para vers√£o mais recente
      # Evita problemas de compatibilidade com depend√™ncias
      
      # Instalar depend√™ncias do sistema para processamento de imagem
      apt-get update && apt-get install -y \
        libgl1-mesa-glx \
        libglib2.0-0 \
        libsm6 \
        libxext6 \
        libxrender-dev \
        libgomp1 \
        libgthread-2.0-0
      # Depend√™ncias necess√°rias para OpenCV e processamento de imagem
      # libgl1-mesa-glx: OpenGL para processamento gr√°fico
      # libglib2.0-0: biblioteca base do GNOME
      # libsm6, libxext6, libxrender-dev: X11 libraries
      # libgomp1: OpenMP para paraleliza√ß√£o
      # libgthread-2.0-0: threading support
      
      pip install -r requirements.txt
      # Instala depend√™ncias Python listadas em requirements.txt
      # -r: l√™ lista de depend√™ncias de arquivo
      # Inclui depend√™ncias: pinecone-client, langchain-pinecone, LlamaIndex, OpenCV, Pillow
      
      npm install -g firecrawl-mcp
      # Instala globalmente o pacote Node.js firecrawl-mcp
      # -g: instala√ß√£o global (dispon√≠vel sistema-wide)
      # Necess√°rio para o MCP Agent funcionar
    
    startCommand: uvicorn app:app --host 0.0.0.0 --port $PORT --workers 1
    # Comando para iniciar aplica√ß√£o em produ√ß√£o
    # uvicorn: servidor ASGI para aplica√ß√µes Python ass√≠ncronas
    # app:app: m√≥dulo:vari√°vel (arquivo app.py, vari√°vel app)
    # --host 0.0.0.0: aceita conex√µes de qualquer IP
    # --port $PORT: usa vari√°vel de ambiente PORT definida pelo Render
    # --workers 1: single worker para evitar conflitos de mem√≥ria com vision models
    
    healthCheckPath: /health
    # Endpoint para verifica√ß√£o de sa√∫de da aplica√ß√£o
    # Render faz requisi√ß√µes GET para este path
    # Se retornar status 200, considera aplica√ß√£o saud√°vel
    # Load balancer usa para determinar se inst√¢ncia est√° funcionando
    
    # Configura√ß√µes de ambiente
    envVars:
    # Lista de vari√°veis de ambiente para a aplica√ß√£o
    
      - key: PYTHON_VERSION
        value: "3.11"
        # Especifica vers√£o Python a ser usada
        # String entre aspas para evitar interpreta√ß√£o como n√∫mero
        # Garante compatibilidade com depend√™ncias LlamaIndex
        
      - key: PORT
        value: "8000"
        # Porta padr√£o para desenvolvimento/fallback
        # Render sobrescreve com porta din√¢mica em produ√ß√£o
        
      - key: NODE_VERSION
        value: "18"
        # Vers√£o Node.js para executar firecrawl-mcp
        # Necess√°ria para compatibilidade do pacote MCP
        
      - key: FIRECRAWL_API_KEY
        sync: false  # Ser√° configurada via dashboard do Render
        # Chave API do Firecrawl
        # sync: false = n√£o sincroniza com reposit√≥rio
        # Deve ser configurada manualmente no dashboard por seguran√ßa
        
      - key: OPENAI_API_KEY
        sync: false  # Ser√° configurada via dashboard do Render
        # Chave API da OpenAI
        # OBRIGAT√ìRIA para ClassificaImagem Agent
        # Configura√ß√£o manual protege credenciais sens√≠veis
        
      - key: PINECONE_API_KEY
        sync: false  # Ser√° configurada via dashboard do Render
        # Chave API do Pinecone para vector database
        # Necess√°ria para funcionalidade RAG (Retrieval-Augmented Generation)
        # Deve ser configurada manualmente por seguran√ßa
        
      # Configura√ß√µes espec√≠ficas do ClassificaImagem Agent
      - key: IMAGE_DOWNLOAD_TIMEOUT
        value: "45"
        # Timeout aumentado para download de imagens em produ√ß√£o
        # 45 segundos para conex√µes mais lentas
        
      - key: MAX_IMAGE_SIZE_MB
        value: "15"
        # Tamanho m√°ximo reduzido para otimizar performance
        # 15MB para evitar problemas de mem√≥ria no free tier
        
      - key: VISION_MODEL
        value: "gpt-4o-mini"
        # Modelo padr√£o para an√°lise de imagem
        # gpt-4o-mini: mais econ√¥mico e r√°pido
        
      - key: VISION_TEMPERATURE
        value: "0.1"
        # Temperatura baixa para respostas mais determin√≠sticas
        # Importante para an√°lises consistentes
        
      - key: VISION_MAX_TOKENS
        value: "3000"
        # M√°ximo de tokens reduzido para otimizar custo
        # 3000 tokens suficiente para an√°lises detalhadas
        
      - key: IMAGE_ANALYSIS_LOGGING
        value: "false"
        # Desabilitar logs detalhados em produ√ß√£o
        # Evita polui√ß√£o de logs e melhora performance
        
      - key: ACCEPTED_IMAGE_FORMATS
        value: "jpg,jpeg,png,gif,webp"
        # Formatos de imagem aceitos
        # Exclui BMP para otimiza√ß√£o
    
    # Configura√ß√µes de recurso
    disk:
    # Configura√ß√£o de armazenamento persistente
    
      name: data
      # Nome do volume de dados
      
      mountPath: /opt/render/project/data
      # Caminho onde volume ser√° montado no container
      # /opt/render/project: diret√≥rio padr√£o do Render
      # /data: subdiret√≥rio para dados persistentes
      
      sizeGB: 2
      # Tamanho do disco em 2GB
      # Espa√ßo adicional para cache de imagens e modelos
      # ClassificaImagem pode gerar arquivos tempor√°rios maiores
    
    # Auto-deploy do branch main
    branch: main
    # Branch Git que triggera deploys autom√°ticos
    # Quando main √© atualizado, Render rebuilda automaticamente
    
    # Configura√ß√µes de runtime
    runtime: python3
    # Runtime espec√≠fico: Python 3
    # Redundante com env: python, mas expl√≠cito
    
    # Headers de seguran√ßa personalizados
    headers:
    # Lista de headers HTTP para adicionar √†s respostas
    # Importante para seguran√ßa da aplica√ß√£o web
    
      - path: /*
        # Aplica a todas as rotas (* = wildcard)
        name: X-Frame-Options
        value: DENY
        # Previne embedding em iframes
        # Prote√ß√£o contra clickjacking attacks
        
      - path: /*
        name: X-Content-Type-Options
        value: nosniff
        # Previne MIME type sniffing pelo navegador
        # For√ßa respeitar Content-Type declarado
        
      - path: /*
        name: Referrer-Policy
        value: strict-origin-when-cross-origin
        # Controla informa√ß√µes de referrer enviadas
        # strict-origin-when-cross-origin: m√°xima privacidade
        
      - path: /*
        name: Permissions-Policy
        value: geolocation=(), microphone=(), camera=()
        # Desabilita APIs sens√≠veis do navegador
        # geolocation, microphone, camera: lista vazia = negado
        
      - path: /imagem/*
        name: Cache-Control
        value: no-cache, no-store, must-revalidate
        # Headers espec√≠ficos para endpoints de imagem
        # Evita cache de an√°lises sens√≠veis
    
    # Configura√ß√µes de sa√∫de
    initialDelaySeconds: 60
    # Tempo de espera antes do primeiro health check
    # 60 segundos: permite inicializa√ß√£o completa da aplica√ß√£o
    # ClassificaImagem Agent precisa carregar modelos LlamaIndex
    # Tempo aumentado para acomodar carregamento de depend√™ncias de vis√£o
    
    # Configura√ß√µes de build
    buildFilter:
    # Filtros para otimizar builds
    # Define quais mudan√ßas triggeram rebuild
    
      paths:
      # Lista de caminhos que trigeram rebuild quando modificados
        - app.py
        # Arquivo principal da aplica√ß√£o
        - requirements.txt
        # Depend√™ncias Python (atualizado com LlamaIndex)
        - agents/**
        # Todos os arquivos no diret√≥rio agents
        # **: wildcard recursivo (inclui subdiret√≥rios)
        # Inclui novo classifica_imagem_agent.py
        - static/**
        # Arquivos est√°ticos (CSS, JS)
        - pages/**
        # Templates HTML (index.html atualizado)
        
      ignoredPaths:
      # Caminhos ignorados (n√£o trigeram rebuild)
        - README.md
        # Documenta√ß√£o n√£o afeta funcionamento
        - .gitignore
        # Configura√ß√£o Git
        - .env*
        # Arquivos de ambiente (cont√™m credenciais)
        # .env*: wildcard para .env, .env.local, etc.
        - docs/**
    
    # Configura√ß√µes de mem√≥ria e CPU
    scaling:
    # Configura√ß√µes de escalabilidade
      minInstances: 1
      # M√≠nimo de 1 inst√¢ncia sempre ativa
      # Evita cold starts para ClassificaImagem Agent
      
      maxInstances: 2
      # M√°ximo de 2 inst√¢ncias no free tier
      # ClassificaImagem Agent pode ser memory-intensive
    
    # Configura√ß√µes de rede
    routes:
    # Configura√ß√µes de roteamento espec√≠ficas
      - type: rewrite
        source: /imagem/analyze
        destination: /imagem/analyze
        # Rota espec√≠fica para an√°lise de imagem
        
      - type: rewrite
        source: /docs
        destination: /docs
        # Mant√©m documenta√ß√£o da API acess√≠vel

# Configura√ß√µes globais do deploy
buildCommand: |
  # Comando global de build executado uma vez
  echo "üöÄ Iniciando deploy dos Agentes de IA - v1.4.0"
  echo "üì¶ Instalando depend√™ncias para ClassificaImagem Agent..."
  echo "üñºÔ∏è Configurando processamento de imagem..."
  echo "‚úÖ Build conclu√≠do com sucesso!"

# Notifica√ß√µes de deploy
notifications:
  # Lista de notifica√ß√µes para eventos de deploy
  - type: email
    # Tipo de notifica√ß√£o
    events: [deploy-succeeded, deploy-failed]
    # Eventos que triggeram notifica√ß√£o
    filter:
      branch: main
      # Apenas para branch main