<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentes de IA - FIA</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 70vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background: #3b82f6;
            color: white;
            margin-left: auto;
        }
        .bot-message {
            background: #f3f4f6;
            color: #374151;
            margin-right: auto;
        }
        .typing-indicator {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .typing-indicator.show {
            opacity: 1;
        }
        .agent-selector {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .rag-sources {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            margin-top: 10px;
            border-radius: 0 8px 8px 0;
        }
        .confidence-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            transition: width 0.3s ease;
        }
        .knowledge-panel {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .knowledge-panel.show {
            display: block;
        }
        .externo-panel {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .externo-panel.show {
            display: block;
        }
        .mermaid-panel {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .mermaid-panel.show {
            display: block;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online {
            background-color: #10b981;
        }
        .status-offline {
            background-color: #ef4444;
        }
        .status-checking {
            background-color: #f59e0b;
            animation: pulse 1s infinite;
        }
        .diagram-type-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .diagram-type-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .diagram-type-card.selected {
            border-color: #1d4ed8;
            background: #dbeafe;
        }
        .mermaid-diagram {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin: 10px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            overflow-x: auto;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .chat-container {
                height: 60vh;
            }
            .message-bubble {
                max-width: 95%;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-robot text-2xl text-blue-600"></i>
                    <h1 class="text-xl font-bold text-gray-900">Agentes de IA - FIA</h1>
                </div>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-university mr-1"></i>
                    FIA.LabData - Prof. Sergio Gaiotto
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto p-4">
        <!-- Agent Selection -->
        <div class="mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4">
                <h2 class="text-lg font-semibold mb-3 text-gray-800">
                    <i class="fas fa-cogs mr-2"></i>Selecione o Agente
                </h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <!-- MCP Agent -->
                    <div class="agent-selector rounded-lg p-4 cursor-pointer transition-all hover:shadow-md" 
                         onclick="selectAgent('mcp')" id="mcp-card">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-link text-blue-600 mr-2"></i>
                            <h3 class="font-semibold text-gray-800">Agente MCP Firecrawl</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">
                            Integração dinâmica com ferramentas externas via Model Context Protocol, neste caso Firecrawl
                        </p>
                        <div class="flex flex-wrap gap-1">
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">Scraping Real-time</span>
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">MCP Integration</span>
                            <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">Conversacional</span>
                        </div>
                    </div>

                    <!-- Workflow Agent -->
                    <div class="agent-selector rounded-lg p-4 cursor-pointer transition-all hover:shadow-md"
                         onclick="selectAgent('workflow')" id="workflow-card">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-sitemap text-green-600 mr-2"></i>
                            <h3 class="font-semibold text-gray-800">Agente Workflow Firecrawl</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">
                            Pesquisa estruturada e análise comparativa de produtos e serviços, neste caso Firecrawl
                        </p>
                        <div class="flex flex-wrap gap-1">
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">Workflow Estruturado</span>
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">Análise Comparativa</span>
                            <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">Recomendações</span>
                        </div>
                    </div>

                    <!-- RAG Agent -->
                    <div class="agent-selector rounded-lg p-4 cursor-pointer transition-all hover:shadow-md"
                         onclick="selectAgent('rag')" id="rag-card">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-brain text-purple-600 mr-2"></i>
                            <h3 class="font-semibold text-gray-800">Agente RAG</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">
                            Retrieval-Augmented Generation com base de conhecimento Pinecone
                        </p>
                        <div class="flex flex-wrap gap-1">
                            <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">Pesquisa Semântica</span>
                            <span class="px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded">Base Conhecimento</span>
                            <span class="px-2 py-1 bg-pink-100 text-pink-800 text-xs rounded">Citação Fontes</span>
                        </div>
                    </div>

                    <!-- Agente Externo -->
                    <div class="agent-selector rounded-lg p-4 cursor-pointer transition-all hover:shadow-md"
                         onclick="selectAgent('externo')" id="externo-card">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-globe text-orange-600 mr-2"></i>
                            <h3 class="font-semibold text-gray-800">Agente Externo</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">
                            Integração com APIs externas (Flowise) para processamento especializado
                        </p>
                        <div class="flex flex-wrap gap-1">
                            <span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded">API Externa</span>
                            <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">Flowise</span>
                            <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">Contextual</span>
                        </div>
                    </div>

                    <!-- Tool Mermaid Agent -->
                    <div class="agent-selector rounded-lg p-4 cursor-pointer transition-all hover:shadow-md"
                         onclick="selectAgent('mermaid')" id="mermaid-card">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-project-diagram text-teal-600 mr-2"></i>
                            <h3 class="font-semibold text-gray-800">Tool Mermaid</h3>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">
                            Geração de diagramas Mermaid para visualização de processos e estruturas
                        </p>
                        <div class="flex flex-wrap gap-1">
                            <span class="px-2 py-1 bg-teal-100 text-teal-800 text-xs rounded">Diagramas</span>
                            <span class="px-2 py-1 bg-cyan-100 text-cyan-800 text-xs rounded">Mermaid</span>
                            <span class="px-2 py-1 bg-emerald-100 text-emerald-800 text-xs rounded">Visualização</span>
                        </div>
                    </div>
                </div>
                
                <!-- Selected Agent Display -->
                <div id="selected-agent" class="mt-4 p-3 bg-blue-50 rounded-lg hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                            <span class="font-medium">Agente selecionado: </span>
                            <span id="selected-agent-name" class="font-bold text-blue-600"></span>
                        </div>
                        <!-- Agent-specific buttons -->
                        <div class="flex space-x-2">
                            <!-- RAG Knowledge Management Button -->
                            <button id="knowledge-btn" class="hidden bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors" onclick="toggleKnowledgePanel()">
                                <i class="fas fa-database mr-1"></i>Gerenciar Base
                            </button>
                            <!-- Externo Status Button -->
                            <button id="externo-btn" class="hidden bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700 transition-colors" onclick="toggleExternoPanel()">
                                <i class="fas fa-cog mr-1"></i>Status & Config
                            </button>
                            <!-- Mermaid Diagram Panel Button -->
                            <button id="mermaid-btn" class="hidden bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-teal-700 transition-colors" onclick="toggleMermaidPanel()">
                                <i class="fas fa-project-diagram mr-1"></i>Tipos de Diagrama
                            </button>
                        </div>
                    </div>
                </div>

                <!-- RAG Knowledge Management Panel -->
                <div id="knowledge-panel" class="knowledge-panel">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">
                        <i class="fas fa-database mr-2"></i>Gerenciamento da Base de Conhecimento
                    </h3>
                    
                    <!-- Knowledge Stats -->
                    <div id="knowledge-stats" class="bg-gray-50 rounded p-3 mb-4">
                        <div class="text-sm text-gray-600">Carregando estatísticas...</div>
                    </div>

                    <!-- Add Knowledge Forms -->
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <!-- Add from URL -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-medium mb-2">Adicionar via URL</h4>
                            <div class="space-y-2">
                                <input type="url" id="knowledge-url" placeholder="https://exemplo.com/artigo" 
                                       class="w-full border rounded px-3 py-2 text-sm">
                                <button onclick="addKnowledgeFromURL()" 
                                        class="w-full bg-blue-600 text-white py-2 rounded text-sm hover:bg-blue-700">
                                    <i class="fas fa-globe mr-1"></i>Adicionar URL
                                </button>
                            </div>
                        </div>

                        <!-- Add from Text -->
                        <div class="border rounded-lg p-4">
                            <h4 class="font-medium mb-2">Adicionar Texto</h4>
                            <div class="space-y-2">
                                <input type="text" id="knowledge-source" placeholder="ID da fonte" 
                                       class="w-full border rounded px-3 py-2 text-sm">
                                <textarea id="knowledge-text" placeholder="Cole o texto aqui..." 
                                          class="w-full border rounded px-3 py-2 text-sm h-20 resize-none"></textarea>
                                <button onclick="addKnowledgeFromText()" 
                                        class="w-full bg-green-600 text-white py-2 rounded text-sm hover:bg-green-700">
                                    <i class="fas fa-file-text mr-1"></i>Adicionar Texto
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Suggested Sources -->
                    <div class="border-t pt-4">
                        <h4 class="font-medium mb-2">Sugestões de Fontes</h4>
                        <div class="flex space-x-2 mb-2">
                            <input type="text" id="suggest-domain" placeholder="Ex: machine learning" 
                                   class="flex-1 border rounded px-3 py-2 text-sm">
                            <button onclick="suggestSources()" 
                                    class="bg-yellow-600 text-white px-4 py-2 rounded text-sm hover:bg-yellow-700">
                                <i class="fas fa-lightbulb mr-1"></i>Sugerir
                            </button>
                        </div>
                        <div id="suggested-sources" class="text-sm text-gray-600"></div>
                    </div>
                </div>

                <!-- Externo Agent Panel -->
                <div id="externo-panel" class="externo-panel">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">
                        <i class="fas fa-globe mr-2"></i>Agente Externo - Status & Configuração
                    </h3>
                    
                    <!-- Status Display -->
                    <div id="externo-status" class="bg-gray-50 rounded p-3 mb-4">
                        <div class="text-sm text-gray-600">Verificando status...</div>
                    </div>

                    <!-- Control Buttons -->
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <button onclick="checkExternoStatus()" 
                                class="bg-blue-600 text-white py-2 px-4 rounded text-sm hover:bg-blue-700">
                            <i class="fas fa-sync mr-1"></i>Verificar Status
                        </button>
                        <button onclick="resetExternoConversation()" 
                                class="bg-yellow-600 text-white py-2 px-4 rounded text-sm hover:bg-yellow-700">
                            <i class="fas fa-refresh mr-1"></i>Reset Conversa
                        </button>
                        <button onclick="testExternoConnection()" 
                                class="bg-green-600 text-white py-2 px-4 rounded text-sm hover:bg-green-700">
                            <i class="fas fa-vial mr-1"></i>Testar Conexão
                        </button>
                    </div>

                    <!-- Configuration Info -->
                    <div class="border-t pt-4">
                        <h4 class="font-medium mb-2">Informações da API</h4>
                        <div id="externo-config" class="text-sm text-gray-600 bg-white rounded p-3 border">
                            <div class="mb-2">
                                <strong>Tipo:</strong> Flowise API
                            </div>
                            <div class="mb-2">
                                <strong>Contexto:</strong> Mantém histórico de conversa
                            </div>
                            <div>
                                <strong>Timeout:</strong> 30 segundos
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mermaid Agent Panel -->
                <div id="mermaid-panel" class="mermaid-panel">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">
                        <i class="fas fa-project-diagram mr-2"></i>Tool Mermaid - Tipos de Diagrama
                    </h3>
                    
                    <!-- Diagram Type Selector -->
                    <div class="mb-4">
                        <h4 class="font-medium mb-2">Selecione o tipo de diagrama:</h4>
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3" id="diagram-type-selector">
                            <!-- Será preenchido dinamicamente via JavaScript -->
                        </div>
                    </div>

                    <!-- Selected Diagram Info -->
                    <div id="selected-diagram-info" class="bg-gray-50 rounded p-3 mb-4 hidden">
                        <div class="font-medium mb-1" id="selected-diagram-name"></div>
                        <div class="text-sm text-gray-600" id="selected-diagram-description"></div>
                    </div>

                    <!-- Diagram History -->
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-medium">Histórico de Diagramas</h4>
                            <button onclick="resetMermaidHistory()" 
                                    class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                <i class="fas fa-trash mr-1"></i>Limpar
                            </button>
                        </div>
                        <div id="mermaid-history" class="text-sm text-gray-600">
                            Carregando histórico...
                        </div>
                    </div>

                    <!-- Example Prompts -->
                    <div class="border-t pt-4 mt-4">
                        <h4 class="font-medium mb-2">Exemplos de Prompts</h4>
                        <div class="space-y-2">
                            <button onclick="useSamplePrompt('Crie um diagrama de sequência para login de usuário com autenticação')" 
                                    class="w-full text-left bg-blue-50 hover:bg-blue-100 p-2 rounded text-sm border">
                                Login com autenticação (Sequência)
                            </button>
                            <button onclick="useSamplePrompt('Fluxograma para processo de aprovação de pedidos')" 
                                    class="w-full text-left bg-green-50 hover:bg-green-100 p-2 rounded text-sm border">
                                Aprovação de pedidos (Fluxograma)
                            </button>
                            <button onclick="useSamplePrompt('Diagrama de classes para sistema de biblioteca')" 
                                    class="w-full text-left bg-purple-50 hover:bg-purple-100 p-2 rounded text-sm border">
                                Sistema de biblioteca (Classes)
                            </button>
                            <button onclick="useSamplePrompt('Gráfico de Gantt para projeto de desenvolvimento de app em 3 meses')" 
                                    class="w-full text-left bg-yellow-50 hover:bg-yellow-100 p-2 rounded text-sm border">
                                Projeto 3 meses (Gantt)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <!-- Chat Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold">
                        <i class="fas fa-comments mr-2"></i>Chat com Agente
                    </h2>
                    <button onclick="clearChat()" class="text-white hover:text-gray-200 transition-colors">
                        <i class="fas fa-trash mr-1"></i>Limpar
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="chat-container p-4 overflow-y-auto space-y-4">
                <!-- Welcome Message -->
                <div class="message-bubble bot-message rounded-lg p-3 shadow-sm">
                    <div class="flex items-start space-x-2">
                        <i class="fas fa-robot text-blue-600 mt-1"></i>
                        <div>
                            <p class="text-sm">Olá! Selecione um agente acima e me faça uma pergunta.</p>
                            <div class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-clock mr-1"></i>Sistema iniciado
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typing-indicator" class="typing-indicator p-4 border-t">
                <div class="flex items-center space-x-2 text-gray-500">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                    <span class="text-sm">Agente está processando...</span>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t bg-gray-50">
                <div class="flex space-x-3">
                    <input type="text" 
                           id="message-input" 
                           placeholder="Digite sua pergunta..." 
                           class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()" 
                            id="send-button"
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane mr-1"></i>Enviar
                    </button>
                </div>
                <div class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span id="input-hint">Selecione um agente primeiro</span>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script>
        let selectedAgent = null;
        let selectedDiagramType = 'sequence'; // Para agente Mermaid
        let isProcessing = false;

        function selectAgent(agentType) {
            selectedAgent = agentType;
            
            // Update visual selection
            document.querySelectorAll('.agent-selector').forEach(card => {
                card.classList.remove('bg-blue-100', 'border-blue-300', 'shadow-md');
                card.classList.add('bg-white');
            });
            
            const selectedCard = document.getElementById(`${agentType}-card`);
            selectedCard.classList.remove('bg-white');
            selectedCard.classList.add('bg-blue-100', 'border-blue-300', 'shadow-md');
            
            // Show selected agent
            const selectedAgentDiv = document.getElementById('selected-agent');
            const selectedAgentName = document.getElementById('selected-agent-name');
            const knowledgeBtn = document.getElementById('knowledge-btn');
            const externoBtn = document.getElementById('externo-btn');
            const mermaidBtn = document.getElementById('mermaid-btn');
            
            selectedAgentDiv.classList.remove('hidden');
            
            const agentNames = {
                'mcp': 'Agente MCP Firecrawl',
                'workflow': 'Agente Workflow Firecrawl',
                'rag': 'Agente RAG',
                'externo': 'Agente Externo',
                'mermaid': 'Tool Mermaid Agent'
            };
            
            selectedAgentName.textContent = agentNames[agentType];
            
            // Hide all special buttons first
            knowledgeBtn.classList.add('hidden');
            externoBtn.classList.add('hidden');
            mermaidBtn.classList.add('hidden');
            
            // Show relevant button based on agent type
            if (agentType === 'rag') {
                knowledgeBtn.classList.remove('hidden');
                loadKnowledgeStats();
                updateInputHint('Faça perguntas baseadas na base de conhecimento...');
            } else if (agentType === 'mermaid') {
                mermaidBtn.classList.remove('hidden');
                loadDiagramTypes();
                updateInputHint('Descreva o diagrama que deseja criar e processo que precisa ser estruturado...');
            } else if (agentType === 'externo') {
                externoBtn.classList.remove('hidden');
                updateInputHint('Envie prompts para processamento via API para o Flowise...');
            } else if (agentType === 'mcp') {
                updateInputHint(`Pergunte algo para o ${agentNames[agentType]}, p.e., "me traga o top 5 smartphones"...`);
            } else if (agentType === 'workflow') {
                updateInputHint(`Pergunte algo para o ${agentNames[agentType]}, p.e., "compare os serviços das cloud platforms"...`);
            } else {
                updateInputHint(`Pergunte algo para o ${agentNames[agentType]}...`);
            }
            
            // Hide all panels
            document.getElementById('knowledge-panel').classList.remove('show');
            document.getElementById('externo-panel').classList.remove('show');
            document.getElementById('mermaid-panel').classList.remove('show');
            
            // Enable input
            document.getElementById('message-input').placeholder = 
                `Pergunte algo para o ${agentNames[agentType]}...`;
        }

        function updateInputHint(text) {
            document.getElementById('input-hint').textContent = text;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            if (!selectedAgent) {
                alert('Por favor, selecione um agente primeiro!');
                return;
            }

            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message || isProcessing) return;

            // Add user message to chat
            addMessage(message, 'user');
            messageInput.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            isProcessing = true;
            
            try {
                // Prepare request body
                const requestBody = {
                    message: message,
                    agent_type: selectedAgent
                };
                
                // Add diagram type for Mermaid agent
                if (selectedAgent === 'mermaid') {
                    requestBody.diagram_type = selectedDiagramType;
                }

                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Add bot response with special handling for RAG and Mermaid
                addMessage(data.response, 'bot', data.status, data);
                
            } catch (error) {
                hideTypingIndicator();
                addMessage('❌ Erro de conexão. Tente novamente.', 'bot', 'error');
            } finally {
                isProcessing = false;
            }
        }

        function addMessage(content, sender, status = 'success', data = null) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            
            const isUser = sender === 'user';
            const bubbleClass = isUser ? 'user-message' : 'bot-message';
            const icon = isUser ? 'fas fa-user' : 'fas fa-robot';
            const iconColor = isUser ? 'text-white' : (status === 'error' ? 'text-red-600' : 'text-blue-600');
            
            let ragExtras = '';
            
            // Add RAG-specific elements
            if (!isUser && selectedAgent === 'rag' && data && status === 'success') {
                // Confidence bar
                if (data.confidence !== null && data.confidence !== undefined) {
                    const confidencePercent = Math.round(data.confidence * 100);
                    ragExtras += `
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                <span>Confiança da resposta</span>
                                <span>${confidencePercent}%</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                            </div>
                        </div>
                    `;
                }
                
                // Sources
                if (data.sources && data.sources.length > 0) {
                    ragExtras += `
                        <div class="rag-sources mt-3">
                            <div class="font-medium text-sm text-gray-700 mb-2">
                                <i class="fas fa-book mr-1"></i>Fontes utilizadas (${data.sources.length}):
                            </div>
                            <div class="space-y-2">
                    `;
                    
                    data.sources.forEach((source, index) => {
                        const score = source.score ? `${Math.round(source.score * 100)}%` : 'N/A';
                        const sourceUrl = source.metadata.source_url || source.metadata.source_id || 'Fonte interna';
                        
                        ragExtras += `
                            <div class="text-xs bg-white p-2 rounded border-l-2 border-blue-400">
                                <div class="font-medium text-gray-700">${index + 1}. ${sourceUrl}</div>
                                <div class="text-gray-600 mt-1">${source.content}</div>
                                <div class="text-gray-500 mt-1">Similaridade: ${score}</div>
                            </div>
                        `;
                    });
                    
                    ragExtras += `
                            </div>
                        </div>
                    `;
                }
            }
            
            // Add Mermaid-specific elements
            if (!isUser && selectedAgent === 'mermaid' && status === 'success') {
                // Extract Mermaid code from response and render it
                const mermaidMatch = content.match(/```mermaid\s*([\s\S]*?)\s*```/);
                if (mermaidMatch) {
                    const mermaidCode = mermaidMatch[1];
                    const timestamp = Date.now();
                    ragExtras += `
                        <div class="mt-3">
                            <div class="font-medium text-sm text-gray-700 mb-2">
                                <i class="fas fa-project-diagram mr-1"></i>Diagrama Mermaid:
                            </div>
                            <div class="mermaid-diagram" id="mermaid-${timestamp}">
                                <pre>${mermaidCode}</pre>
                            </div>
                            <div class="mt-2 space-x-2">
                                <button onclick="copyMermaidCode('${timestamp}')" 
                                        class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-teal-700">
                                    <i class="fas fa-copy mr-1"></i>Copiar Código
                                </button>
                                <button onclick="openMermaidLive('${timestamp}')" 
                                        class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                    <i class="fas fa-external-link-alt mr-1"></i>Visualizar Online
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
            
            messageDiv.className = `message-bubble ${bubbleClass} rounded-lg p-3 shadow-sm`;
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-2">
                    <i class="${icon} ${iconColor} mt-1"></i>
                    <div class="flex-1">
                        <div class="whitespace-pre-wrap">${formatMessage(content)}</div>
                        ${ragExtras}
                        <div class="text-xs ${isUser ? 'text-blue-100' : 'text-gray-500'} mt-2">
                            <i class="fas fa-clock mr-1"></i>${new Date().toLocaleTimeString()}
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatMessage(content) {
            // Simple markdown-like formatting
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code class="bg-gray-200 px-1 rounded">$1</code>')
                .replace(/\n/g, '<br>');
        }

        function showTypingIndicator() {
            document.getElementById('typing-indicator').classList.add('show');
            document.getElementById('send-button').disabled = true;
        }

        function hideTypingIndicator() {
            document.getElementById('typing-indicator').classList.remove('show');
            document.getElementById('send-button').disabled = false;
        }

        function clearChat() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = `
                <div class="message-bubble bot-message rounded-lg p-3 shadow-sm">
                    <div class="flex items-start space-x-2">
                        <i class="fas fa-robot text-blue-600 mt-1"></i>
                        <div>
                            <p class="text-sm">Chat limpo! Como posso ajudar?</p>
                            <div class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-clock mr-1"></i>${new Date().toLocaleTimeString()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // RAG Knowledge Management Functions
        function toggleKnowledgePanel() {
            const panel = document.getElementById('knowledge-panel');
            panel.classList.toggle('show');
            
            if (panel.classList.contains('show')) {
                loadKnowledgeStats();
            }
        }

        async function loadKnowledgeStats() {
            try {
                const response = await fetch('/rag/stats');
                const stats = await response.json();
                
                const statsDiv = document.getElementById('knowledge-stats');
                
                if (stats.knowledge_base && stats.knowledge_base.total_vectors !== undefined) {
                    statsDiv.innerHTML = `
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="font-medium">Documentos Indexados</div>
                                <div class="text-lg font-bold text-blue-600">${stats.knowledge_base.total_vectors || 0}</div>
                            </div>
                            <div>
                                <div class="font-medium">Status do Índice</div>
                                <div class="text-lg font-bold text-green-600">${stats.knowledge_base.status}</div>
                            </div>
                        </div>
                    `;
                } else {
                    statsDiv.innerHTML = `
                        <div class="text-center text-yellow-600">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Base de conhecimento não inicializada
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('knowledge-stats').innerHTML = `
                    <div class="text-center text-red-600">
                        <i class="fas fa-times-circle mr-1"></i>
                        Erro ao carregar estatísticas
                    </div>
                `;
            }
        }

        async function addKnowledgeFromURL() {
            const url = document.getElementById('knowledge-url').value.trim();
            
            if (!url) {
                alert('Por favor, insira uma URL válida');
                return;
            }
            
            try {
                const response = await fetch('/rag/knowledge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('✅ Conhecimento adicionado com sucesso!');
                    document.getElementById('knowledge-url').value = '';
                    loadKnowledgeStats();
                } else {
                    alert('❌ Erro: ' + result.message);
                }
            } catch (error) {
                alert('❌ Erro de conexão: ' + error.message);
            }
        }

        async function addKnowledgeFromText() {
            const text = document.getElementById('knowledge-text').value.trim();
            const sourceId = document.getElementById('knowledge-source').value.trim();
            
            if (!text || !sourceId) {
                alert('Por favor, preencha o texto e o ID da fonte');
                return;
            }
            
            try {
                const response = await fetch('/rag/knowledge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        text: text,
                        source_id: sourceId 
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('✅ Texto adicionado com sucesso!');
                    document.getElementById('knowledge-text').value = '';
                    document.getElementById('knowledge-source').value = '';
                    loadKnowledgeStats();
                } else {
                    alert('❌ Erro: ' + result.message);
                }
            } catch (error) {
                alert('❌ Erro de conexão: ' + error.message);
            }
        }

        async function suggestSources() {
            const domain = document.getElementById('suggest-domain').value.trim();
            
            if (!domain) {
                alert('Por favor, insira um domínio de conhecimento');
                return;
            }
            
            try {
                const response = await fetch(`/rag/suggest-sources/${encodeURIComponent(domain)}`);
                const result = await response.json();
                
                const suggestedDiv = document.getElementById('suggested-sources');
                
                if (result.suggested_sources && result.suggested_sources.length > 0) {
                    const sourcesList = result.suggested_sources.map(url => 
                        `<div class="flex items-center justify-between bg-gray-50 p-2 rounded mb-1">
                            <span class="text-xs flex-1 mr-2">${url}</span>
                            <button onclick="addSuggestedSource('${url}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                                Adicionar
                            </button>
                        </div>`
                    ).join('');
                    
                    suggestedDiv.innerHTML = `
                        <div class="mb-2 font-medium">Fontes sugeridas para "${domain}":</div>
                        ${sourcesList}
                    `;
                } else {
                    suggestedDiv.innerHTML = `
                        <div class="text-yellow-600">
                            <i class="fas fa-info-circle mr-1"></i>
                            Nenhuma fonte encontrada para "${domain}"
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('suggested-sources').innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-times-circle mr-1"></i>
                        Erro ao buscar sugestões
                    </div>
                `;
            }
        }

        function addSuggestedSource(url) {
            document.getElementById('knowledge-url').value = url;
            // Scroll to URL input
            document.getElementById('knowledge-url').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('knowledge-url').focus();
        }

        // Externo Agent Functions
        function toggleExternoPanel() {
            const panel = document.getElementById('externo-panel');
            panel.classList.toggle('show');
            
            if (panel.classList.contains('show')) {
                checkExternoStatus();
            }
        }

        async function checkExternoStatus() {
            const statusDiv = document.getElementById('externo-status');
            statusDiv.innerHTML = `
                <div class="flex items-center text-sm text-gray-600">
                    <span class="status-indicator status-checking"></span>
                    Verificando status da API Flowise...
                </div>
            `;
            
            try {
                const response = await fetch('/externo/status');
                const status = await response.json();
                
                const statusClass = status.status === 'available' ? 'status-online' : 'status-offline';
                const statusText = status.status === 'available' ? 'Online' : 'Offline';
                const statusColor = status.status === 'available' ? 'text-green-600' : 'text-red-600';
                
                statusDiv.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <div class="font-medium">Status da API</div>
                            <div class="flex items-center ${statusColor}">
                                <span class="status-indicator ${statusClass}"></span>
                                ${statusText}
                            </div>
                        </div>
                        <div>
                            <div class="font-medium">Mensagens na Sessão</div>
                            <div class="text-lg font-bold text-blue-600">${status.message_count || 0}</div>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        Endpoint: ${status.endpoint || 'N/A'}<br>
                        Sessão: ${status.session_id || 'N/A'}
                    </div>
                `;
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="flex items-center text-sm text-red-600">
                        <span class="status-indicator status-offline"></span>
                        Erro ao verificar status: ${error.message}
                    </div>
                `;
            }
        }

        async function resetExternoConversation() {
            if (!confirm('Tem certeza que deseja resetar a conversa? O histórico será perdido.')) {
                return;
            }
            
            try {
                const response = await fetch('/externo/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('✅ Conversa resetada com sucesso!');
                    checkExternoStatus(); // Atualizar status
                } else {
                    alert('❌ Erro ao resetar conversa');
                }
            } catch (error) {
                alert('❌ Erro de conexão: ' + error.message);
            }
        }

        async function testExternoConnection() {
            const statusDiv = document.getElementById('externo-status');
            const originalContent = statusDiv.innerHTML;
            
            statusDiv.innerHTML = `
                <div class="flex items-center text-sm text-blue-600">
                    <span class="status-indicator status-checking"></span>
                    Testando conexão com Flowise...
                </div>
            `;
            
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: 'test connection',
                        agent_type: 'externo'
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('✅ Conexão testada com sucesso!');
                } else {
                    alert('❌ Falha no teste de conexão:\n' + data.response);
                }
                
            } catch (error) {
                alert('❌ Erro no teste de conexão: ' + error.message);
            } finally {
                // Restaurar conteúdo original após um breve delay
                setTimeout(() => {
                    statusDiv.innerHTML = originalContent;
                }, 2000);
            }
        }

        // Mermaid Agent Functions
        function toggleMermaidPanel() {
            const panel = document.getElementById('mermaid-panel');
            panel.classList.toggle('show');
            
            if (panel.classList.contains('show')) {
                loadDiagramTypes();
                loadMermaidHistory();
            }
        }

        async function loadDiagramTypes() {
            try {
                const response = await fetch('/mermaid/diagram-types');
                const data = await response.json();
                
                const selectorDiv = document.getElementById('diagram-type-selector');
                
                if (data.supported_diagrams && data.supported_diagrams.length > 0) {
                    selectorDiv.innerHTML = data.supported_diagrams.map(diagram => `
                        <div class="diagram-type-card ${diagram.type === selectedDiagramType ? 'selected' : ''}" 
                             onclick="selectDiagramType('${diagram.type}')">
                            <div class="font-medium text-sm">${diagram.name}</div>
                            <div class="text-xs text-gray-600 mt-1">${diagram.description}</div>
                        </div>
                    `).join('');
                } else {
                    selectorDiv.innerHTML = `
                        <div class="text-center text-gray-500 col-span-full">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Tipos de diagrama não disponíveis
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('diagram-type-selector').innerHTML = `
                    <div class="text-center text-red-600 col-span-full">
                        <i class="fas fa-times-circle mr-1"></i>
                        Erro ao carregar tipos de diagrama
                    </div>
                `;
            }
        }

        function selectDiagramType(type) {
            selectedDiagramType = type;
            
            // Update visual selection
            document.querySelectorAll('.diagram-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.diagram-type-card').classList.add('selected');
            
            // Show info about selected diagram
            const infoDiv = document.getElementById('selected-diagram-info');
            const nameDiv = document.getElementById('selected-diagram-name');
            const descDiv = document.getElementById('selected-diagram-description');
            
            // Map diagram types to friendly names
            const diagramInfo = {
                'sequence': { name: 'Diagrama de Sequência', desc: 'Mostra interações entre entidades ao longo do tempo' },
                'flowchart': { name: 'Fluxograma', desc: 'Representa fluxos de processo e decisões' },
                'classDiagram': { name: 'Diagrama de Classes', desc: 'Mostra estruturas orientadas a objetos' },
                'stateDiagram': { name: 'Diagrama de Estados', desc: 'Representa máquinas de estado e transições' },
                'gantt': { name: 'Gráfico de Gantt', desc: 'Cronogramas e planejamento de projetos' },
                'erDiagram': { name: 'Diagrama ER', desc: 'Modelos de dados e relacionamentos' },
                'journey': { name: 'Jornada do Usuário', desc: 'Experiência do usuário passo a passo' }
            };
            
            const info = diagramInfo[type] || { name: type, desc: 'Tipo de diagrama especializado' };
            nameDiv.textContent = info.name;
            descDiv.textContent = info.desc;
            infoDiv.classList.remove('hidden');
            
            updateInputHint(`Descreva seu ${info.name.toLowerCase()}...`);
        }

        async function loadMermaidHistory() {
            try {
                const response = await fetch('/mermaid/history');
                const data = await response.json();
                
                const historyDiv = document.getElementById('mermaid-history');
                
                if (data.diagram_history && data.diagram_history.length > 0) {
                    const historyHtml = data.diagram_history.slice(0, 5).map((item, index) => {
                        const timestamp = new Date(item.timestamp * 1000).toLocaleString('pt-BR');
                        return `
                            <div class="bg-gray-50 p-2 rounded mb-2">
                                <div class="font-medium text-sm">${item.response.diagram_type}</div>
                                <div class="text-xs text-gray-600">${item.request.prompt.substring(0, 50)}...</div>
                                <div class="text-xs text-gray-500">${timestamp}</div>
                            </div>
                        `;
                    }).join('');
                    
                    historyDiv.innerHTML = `
                        <div class="mb-2 font-medium">Últimos ${Math.min(data.diagram_history.length, 5)} diagramas:</div>
                        ${historyHtml}
                        ${data.diagram_history.length > 5 ? `<div class="text-xs text-gray-500">... e mais ${data.diagram_history.length - 5} diagramas</div>` : ''}
                    `;
                } else {
                    historyDiv.innerHTML = `
                        <div class="text-gray-500 text-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            Nenhum diagrama gerado ainda
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('mermaid-history').innerHTML = `
                    <div class="text-red-600 text-center">
                        <i class="fas fa-times-circle mr-1"></i>
                        Erro ao carregar histórico
                    </div>
                `;
            }
        }

        async function resetMermaidHistory() {
            if (!confirm('Tem certeza que deseja limpar o histórico de diagramas?')) {
                return;
            }
            
            try {
                const response = await fetch('/mermaid/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('✅ Histórico limpo com sucesso!');
                    loadMermaidHistory(); // Reload history
                } else {
                    alert('❌ Erro ao limpar histórico');
                }
            } catch (error) {
                alert('❌ Erro de conexão: ' + error.message);
            }
        }

        function useSamplePrompt(prompt) {
            document.getElementById('message-input').value = prompt;
            document.getElementById('message-input').focus();
            // Scroll to input
            document.getElementById('message-input').scrollIntoView({ behavior: 'smooth' });
        }

        function copyMermaidCode(timestamp) {
            const mermaidDiv = document.getElementById(`mermaid-${timestamp}`);
            const code = mermaidDiv.querySelector('pre').textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                alert('✅ Código Mermaid copiado para a área de transferência!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                alert('❌ Erro ao copiar código. Tente selecionar e copiar manualmente.');
            });
        }

        function openMermaidLive(timestamp) {
            const mermaidDiv = document.getElementById(`mermaid-${timestamp}`);
            const code = mermaidDiv.querySelector('pre').textContent;
            
            // Formato JSON atual do Mermaid Live
            const state = {
                code: code,
                mermaid: {},
                panZoom: true
            };
            const encodedState = btoa(JSON.stringify(state));
            const url = `https://mermaid.live/edit#${encodedState}`;
            
            window.open(url, 'popup', 'width=800,height=600,resizable=yes,scrollbars=yes');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('message-input').focus();
        });
    </script>
</body>
</html>